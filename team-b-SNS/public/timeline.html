<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>タイムライン</title>

    <link href="css/logo.css" rel="stylesheet" />
    
    <!-- BootstrapのCSS読み込み -->
    <link href="css/bootstrap.css" rel="stylesheet" />
    <link href="css/bootstrap.min.css" rel="stylesheet" />

   <!-- 上に戻るボタンの外部CSS（２行セット） -->
   <link href="css/backToTopBTN.css" rel="stylesheet" />
　 <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"/>


    <!-- jQuery読み込み -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <!-- BootstrapのJS読み込み -->
    <script src="js/bootstrap.min.js"></script>


    <!-- 1月17日　田中先生にて修正 -->
    <script src="https://www.gstatic.com/firebasejs/5.5.7/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.7/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.7/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.7/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.7/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.7/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.7/firebase-functions.js"></script>
    <!-- 　これも必要。ページの下の方に入っているかもしれないのでチェックする -->
    <script src="https://www.gstatic.com/firebasejs/5.5.7/firebase.js"></script>

    <script src="js/apiConfig.js"></script>
    <script type="text/javascript" src="js/loginUser.js"></script>
    

    

    <style media="screen">
      body {
        background: white;
        color: rgba(0, 0, 0, 0.87);
        font-family: Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 0;
      }
      #message {
        background: white;
        max-width: 360px;
        margin: 100px auto 16px;
        padding: 32px 24px;
        border-radius: 3px;
      }
      #message h2 {
        color: #ffa100;
        font-weight: bold;
        font-size: 16px;
        margin: 0 0 8px;
      }
      #message h1 {
        font-size: 22px;
        font-weight: 300;
        color: rgba(0, 0, 0, 0.6);
        margin: 0 0 16px;
      }
      #message p {
        line-height: 140%;
        margin: 16px 0 24px;
        font-size: 14px;
      }
      #message a {
        display: block;
        text-align: center;
        background: #039be5;
        text-transform: uppercase;
        text-decoration: none;
        color: white;
        padding: 16px;
        border-radius: 4px;
      }
      #message,
      #message a {
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
      }
      #load {
        color: rgba(0, 0, 0, 0.4);
        text-align: center;
        font-size: 13px;
      }
      @media (max-width: 600px) {
        body,
        #message {
          margin-top: 0;
          background: white;
          box-shadow: none;
        }
        /* body { border-top: 16px solid #ffa100; } */
      }
    </style>
  </head>

    <body id="body00" class="d-none" >
      <header class="sticky-top mb-2 bg-white">
      <!-- 親（ここではheaderタブ）にかかるデフォルトの左右の余白をこのdivに当ててその下のrowにかからないようにするために入れている。 -->
      <div class="col-12">
        <div class="row align-items-end">
          <div id="logo-space" class="col-6  text-left">
            <img class="pc" src="img/logo_2.svg" alt="パソコン用の画像" />
            <img class="sp" src="img/logo.svg" alt="スマートフォン用の画像" />
          </div>

          <div class="col-6 text-right ">
            <span class="">タイムライン</span>
          </div>
        </div>
      </div>
      <hr class="mw-100  bg-light my-4" />
      <!-- 上へ戻るボタン -->
      <div id="page_top"><a href="#"></a></div>
    </header>

    <div id="postBox111"></div>

    <!-- タイムライン全体のbox -->
    <div class="container-fluid">
      <!-- <div class="container-fluid pb-3" style="margin-bottom:100px;"> -->

      <!-- タブ部分 イベント名称-->
      <ul id="tabMenu" class="nav nav-tabs">
        <li class="nav-item">
          <a
            href="#event_1"
            id="tab_1"
            class="nav-link active"
            role="tab"
            data-toggle="tab"
            aria-controls="event_1"
            aria-selected="true"
            >ホワイトデー</a
          >
        </li>
        <li class="nav-item">
          <a
            href="#event_2"
            id="tab_2"
            class="nav-link"
            role="tab"
            data-toggle="tab"
            aria-controls="event_2"
            aria-selected="false"
            >卒業式</a
          >
        </li>
        <li class="nav-item">
          <a
            href="#event_3"
            id="tab_3"
            class="nav-link"
            role="tab"
            data-toggle="tab"
            aria-controls="event_3"
            aria-selected="false"
            >お花見</a
          >
        </li>
      </ul>

      <!-- タブのコンテンツ部分 -->
      <div id="myTabContent" class="tab-content mt-3 container-fluid">
        <!-- １つ目のイベント -->
        <div id="event_1" class="tab-pane active" role="tabpanel" aria-labelledby="event_1-tab">
          <!-- ＃タグのボタン -->
          <div class="container-fluid">
            <div class="btnEvents btnEvent_1">
              <button type="button" name="button" id="whiteday2019" class="btn-sm btn-outline-primary shadow-sm m-1 active">#ホワイトデー2019</button>
              <button type="button" name="button" id="whitedayreturn" class="btn-sm btn-outline-primary shadow-sm m-1">#ホワイトデーお返し</button>
              <button type="button" name="button" id="handmade" class="btn-sm btn-outline-primary shadow-sm m-1">#手作り</button>
              <button type="button" name="button" id="wrapping" class="btn-sm btn-outline-primary shadow-sm m-1">#ラッピング</button>
              <button type="button" name="button" id="present" class="btn-sm btn-outline-primary shadow-sm m-1">#プレゼント</button>
              <button type="button" name="button" id="payback" class="btn-sm btn-outline-primary shadow-sm m-1">#お返しヤバイ</button>
              <button type="button" name="button" id="date" class="btn-sm btn-outline-primary shadow-sm m-1">#デート</button>
            </div>
            <hr class="mw-100 mb-3 w-90 bg-gradient-light" />
          </div>

        </div>

        <!-- イベントのarea 2 -->
        <div id="event_2" class="tab-pane" role="tabpanel" aria-labelledby="event_2-tab">
          <!-- ＃タグのボタン -->
          <div class="container-fluid">
              <div class="btnEvents btnEvent_2">
                  <button type="button" name="button" id="graduation2019" class="btn-sm btn-outline-primary shadow-sm m-1 active">#卒業式2019</button>
                  <button type="button" name="button" id="graduationhair" class="btn-sm btn-outline-primary shadow-sm m-1">#卒業式ヘア</button>
                  <button type="button" name="button" id="graduationcode" class="btn-sm btn-outline-primary shadow-sm m-1">#卒業式コーデ</button>
                  <button type="button" name="button" id="friends" class="btn-sm btn-outline-primary shadow-sm m-1">#友達</button>
                  <button type="button" name="button" id="fellow" class="btn-sm btn-outline-primary shadow-sm m-1">#仲間</button>
                  <button type="button" name="button" id="tears" class="btn-sm btn-outline-primary shadow-sm m-1">#涙</button>
                  <button type="button" name="button" id="wordtogive" class="btn-sm btn-outline-primary shadow-sm m-1">#贈る言葉</button>
                </div>
            <hr class="mw-100 mb-3 w-90 bg-gradient-light" />
          </div>
        </div>
        <!-- イベントのarea 2 終わり-->

        <!-- イベントのarea 3 -->
        <div
          id="event_3"
          class="tab-pane"
          role="tabpanel"
          aria-labelledby="event_3-tab"
        >
          <!-- ＃タグのボタン -->
          <div class="container-fluid">
              <div class="btnEvents btnEvent_3">
                  <button type="button" name="button" id="ohanami2019" class="btn-sm btn-outline-primary shadow-sm m-1">#お花見2019</button>
                  <button type="button" name="button" id="ohanamilunchbox" class="btn-sm btn-outline-primary shadow-sm m-1">#お花見弁当</button>
                  <button type="button" name="button" id="sunflowerviewday" class="btn-sm btn-outline-primary shadow-sm m-1">#お花見日和</button>
                  <button type="button" name="button" id="sakura" class="btn-sm btn-outline-primary shadow-sm m-1">#桜</button>
                  <button type="button" name="button" id="yosakura" class="btn-sm btn-outline-primary shadow-sm m-1">#夜桜</button>
                  <button type="button" name="button" id="sakurasui" class="btn-sm btn-outline-primary shadow-sm m-1">#桜酔</button>
                  <button type="button" name="button" id="placetaking" class="btn-sm btn-outline-primary shadow-sm m-1">#場所取り</button>
                </div>    
            <hr class="mw-100 mb-3 w-90 bg-gradient-light" />
          </div>
        </div>
        <!-- イベントのarea 3 終わり-->
      </div>
      <!-- タブのコンテンツ部分 終わり-->



        <div class="d-none" id="postedEvent"></div>
        <div class="d-none" id="postedtag"></div>
      </div>
      <!-- 投稿内容　イベント・タグ　の確認 終わり-->

<!-- タイムラインをここで一覧表示する -->
      <div class="container-fluid bg-white mw-100 p-2 postList mb-5" id="postArea"></div>


    </div>
    <div class="mb-5"></div>
    <!-- タイムライン全体のbox 終わり-->

    <footer class="fixed-bottom bg-white pb-2">
      <hr class="mb-2 bg-light" />
      <div class="col-12">
        <div class="row">
          <!-- ホームアイコン -->
          <div id="timeLine" class="col-4 text-center">
            <a href="timeLine.html">
              <img
                id="timeLineIcon"
                src="img/home_icon.svg"
                style="width: 40px;"
              />
            </a>
          </div>
          <!-- 新規投稿アイコン -->
          <div id="newPost" class="col-4 text-center">
            <a href="newPostPic.html">
              <img
                id="newPostIcon"
                src="img/newPost_icon.svg"
                style="width: 40px;"
              />
            </a>
          </div>
          <!-- マイページアイコン -->
          <div id="myPage" class="col-4 text-center">
            <a href="myPage.html">
              <img
                id="myPageIcon"
                src="img/myPage_icon.svg"
                style="width: 40px;"
              />
            </a>
          </div>
        </div>
      </div>
    </footer>

    <!-- <script src="https://www.gstatic.com/firebasejs/5.5.8/firebase.js"></script> -->

    <!-- 上へ戻るボタンの実装 -->
    <script>
      $(function() {
        var appear = false;
        var pagetop = $("#page_top");
        $(window).scroll(function() {
          if ($(this).scrollTop() > 50) {
            //100pxスクロールしたら
            if (appear == false) {
              appear = true;
              pagetop.stop().animate(
                {
                  right: "0px" //右から0pxの位置に
                },
                300
              ); //0.3秒かけて現れる
            }
          } else {
            if (appear) {
              appear = false;
              pagetop.stop().animate(
                {
                  right: "-50px" //右から-50pxの位置に
                },
                300
              ); //0.3秒かけて隠れる
            }
          }
        });
        pagetop.click(function() {
          $("body, html").animate({ scrollTop: 0 }, 500); //0.5秒かけてトップへ戻る
          return false;
        });
      });
    </script>

    <!-- #タグのボタンのON と　OFF　の切り替え -->
    <script>
      $(".btnEvents button").click(function() {
        $(".btnEvents button").removeClass("active");
        $(this).addClass("active");
      });
    </script>

    <!-- 選択されたtabと#タグを取得する /　#タグのリセット-->
    <script>
      $(".nav-tabs a").click(tabClicked);
      function tabClicked(e) {
        //ここにクリックされたときの処理を書きます
        e.preventDefault();
        // alert(e.target.innerText);
        // alert( $(e.target).attr("href") );
        var eventHref = $(e.target).attr("href"); //選択したイベントのhrefを取得するならこっちを使う。
        var eventId = $(e.target).attr("id"); //選択したイベントのidを取得するならこっちを使う。
        var postEvent = e.target.innerText; //選択したイベントのタイトルを取得

        console.log(eventHref);
        console.log(eventId);
        console.log(postEvent);

        $("#eventSelected").text(postEvent); //選択したイベントのタイトルを反映
        $("#postedEvent").text(eventId); //サーバー登録用選択した#タグを反映
        $("#tagSelected").text(""); //イベントのtabを押したら、#タグの値がリセットされる
        $("#postedtag").text(""); //イベントのtabを押したら、#タグの値がリセットされる
      }
    </script>


<!--ここは#タグをクリックすると該当する投稿が表示される処理 -->
    <script>
      $(".tab-content button").on("click", function() {


        var tag = this.id;
        // 投稿の要素を削除する処理を呼び出す
        deletePostBox();
        // 投稿を再描画
        readPost(tag);

      });

      function readPost(postTagId) {
        $("#postedtag").text(postTagId); //サーバー登録用選択した#タグを反映

        var postedTagTitle = document.getElementById("postedtag").innerHTML; //RD登録用：選択したタグ
        console.log(postedTagTitle);
        changeEvent_tab1(postTagId);
        changeEvent_tab2(postTagId);
        changeEvent_tab3(postTagId);

        firebase
          .database()
          .ref("/post")
          // .orderByChild('tag').startAt("cosplay").endAt("cosplay")//ここの#タグの名前を選択したら取得できるようにする
          .orderByChild("tag")
          .startAt(postTagId)
          .endAt(postTagId) //ここの#タグの名前を選択したら取得できるようにする

          .on("child_added", function(snapshot) {
            console.log(snapshot.val()); //一位の#タグを使用した投稿IDを取得
            // 一意のIDを取得(postIdは、newPost.jsの、newPostIdと同じ値)
            var postId = snapshot.key; //投稿ID
            var postDate = snapshot.val().date; //投稿した日時
            var postUserID = snapshot.val().userID; //投稿者のユーザーID
            var postUserName = snapshot.val().userName; //投稿者のユーザー名
            var postUserPic = snapshot.val().userPic; //投稿者のプロフ画像
            var eventTitle = snapshot.val().event; //投稿イベント名
            var tagTitle = snapshot.val().tag; //選択したタグ
            var postPic = snapshot.val().photoURL; //投稿した画像名
            var postComment = snapshot.val().comment; //投稿したコメント
            var likesCount = snapshot.val().likesCount; //いいねの数

            console.log("投稿ID=" + postId);
            console.log("投稿した日時=" + postDate);
            console.log("投稿者のユーザーID=" + postUserID);
            console.log("投稿者のプロフ画像" + postUserPic);
            console.log("投稿イベント名=" + eventTitle);
            console.log("選択した#タグ=" + tagTitle);
            console.log("投稿した画像名=" + postPic);
            console.log("投稿したコメント=" + postComment);
            console.log("投稿についたいいね数=" + likesCount);


            const text = `<div class="defaultBox container-fluid myPost mb-3" id="${postId}">
              <div class="border-top border-black-50 mw-100 shadow-sm p-2 mx-2 my-3 ${eventTitle} ${tagTitle}" id="${postId}">

            <div class="row">
              <!-- 投稿のbox -->

              <div class="col-md">
                <!-- 画像のbox ブレイクポイントはMedium（768px〜991px） -->
                <div class="mx-100">
                  <div class="">
                    <!-- 画像 --> <img class="mw-100 postImg" id="${postId}" src="${postPic}">

                  </div>
                </div> <!-- 画像のbox ブレイクポイントはMedium（768px〜991px） 終わり-->
              </div>

              <div class="col-md mt-2">
                <!-- プロフ画像・投稿者名・投稿日・いいね！のbox -->

                <div class=" container-fluid">

                  <div class="row">
                    <!-- プロフ画像 のbox-->
                    <div class="col-2 p-1 text-center">
                       <!-- プロフ画像 -->
                      <img id="${postUserID}" class="rounded-circle bg-primary shadow" src="${postUserPic}" alt="" style="width: 50px; height: 50px;" />
                    </div><!-- プロフ画像 のbox 終わり-->
                    <div class="col-6 container-fluid">
                      <!-- 投稿者名・投稿日 のbox -->
                      <div class="row">
                        <!-- 投稿者名 のbox -->
                        <div class="col-xl">
                          <!-- 投稿者名 --> <small><span id="postUserName" class=" font-weight-bold">${postUserName}</span></small>
                        </div>
                      </div><!-- 投稿者名 のbox 終わり-->
                      <div class="row">
                        <!-- 投稿日 のbox -->
                        <div class="col-xl">
                          <!-- 投稿者名 --> <small><span id="postDate" class="">${postDate}</span></small>
                        </div>
                      </div><!-- 投稿日 のbox 終わり-->
                    </div><!-- 投稿者名・投稿日のbox 終わり-->

                    <div class="col-2 p-0 text-right">
                      <!-- ハート のbox -->
                      <!-- 白ハート --> <img class="whiteHeart" src="img/likes_heart_white.svg" alt="" style="width: 30px;height: 30px;" />
                      <!-- 赤ハート --> <img class="d-none redHeart" src="img/likes_heart.svg" alt="" style="width: 30px; height: 30px;" />
                    </div> <!-- ハート のbox 終わり-->

                    <div id="likesNumber" class="col-2 p-0"><!-- いいねの数 のbox -->
                      <!-- いいね！の数 -->
                      <div id="likeCount" class="mw-100 text-left pl-2" style="font-size:19px; vertical-align:100%">${likesCount}</div>
                    </div> <!-- いいねの数 のbox 終わり-->

                  </div><!-- プロフ画像・投稿者名・投稿日・いいね！のbox 終わり-->

                  <div class="row">
                    <!-- コメントのbox -->
                    <!-- コメント -->
                    <div class="col mw-100 p-1">
                      <div class="mw-100 border border-light shadow-sm">
                        <span class="p-1">${postComment}</span>
                      </div>
                    </div>
                  </div><!-- コメントのbox 終わり-->
                </div><!-- 投稿情報・コメントのbox 終わり-->
              </div><!-- プロフ画像・投稿者名・投稿日・いいね！のbox 終わり-->
            </div><!-- 投稿のbox 終わり-->
          </div>
        </div>`;
            $(".postList").append(text);
          });
      }

      function deletePostBox() {
        $(".defaultBox").remove();
      }


//ページを読み込んだ後に、イベントtabを切り替えた時に、各イベントの最初の#タグに対応する投稿を読み込む（３つ）
      function changeEvent_tab1(){
        $("#tab_1").on('click',function(){
          $(".defaultBox").remove();
          $("#whiteday2019").click();
          exit;
      })
    }

    function changeEvent_tab2(){
        $("#tab_2").on('click',function(){
          $(".defaultBox").remove();
          $("#graduation2019").click();
          exit;
      })
    }

    function changeEvent_tab3(){
        $("#tab_3").on('click',function(){
          $(".defaultBox").remove();
          $("#ohanami2019").click();
          exit;
      })
    }


//白ハートクリックで　いいね！　を１つ追加
$(document).on('click', '.whiteHeart', function() {
        var firebaseId = $(this).parents('.myPost').attr('id');
        var heart = $(this).parent().find('img');
        console.log("いいねした投稿のID------" + firebaseId) //いいねした投稿のID

        heart.each((idx, elem) => {
          if ($(elem).hasClass('d-none')) {
            $(elem).removeClass('d-none');
          } else {
            $(elem).addClass('d-none');
          }
        });

        firebase.auth().onAuthStateChanged(function(user) {
          console.log("いいねしたユーザーID------" + user.uid);　//いいねした人のID
        });

        //クリックした時のサーバーに登録された　いいね　の数を取得
        firebase.database().ref('post/' + firebaseId).once("value").then(function(snapshot) {
        var likes = (snapshot.val() && snapshot.val().likesCount) ;
        var likePlus = 1; 
        var whiteHeartClick = parseInt(likes) + parseInt(likePlus)
        console.log(whiteHeartClick + "=いいねの数(白ハートクリックした時の処理)") //サーバーのいいね数に、１つ追加した数

        //該当の　いいね数　を１増やす
        document.getElementById("likeCount").innerHTML = whiteHeartClick;

      });
    })
//白ハートクリックで　いいね！　を１つ追加　終わり

//赤ハートクリックで　いいね！　を１つマイナス
$(document).on('click', '.redHeart', function() {
        var firebaseId = $(this).parents('.myPost').attr('id');
        var redHeart = $(this).parent().find('img');
        console.log("【赤ハート】いいねした投稿のID------" + firebaseId) //いいねした投稿のID

        redHeart.each((idx, elem) => {
          if ($(elem).hasClass('d-none')) {
            $(elem).removeClass('d-none');
          } else {
            $(elem).addClass('d-none');
          }
        });

        firebase.auth().onAuthStateChanged(function(user) {
          console.log("【赤ハート】いいねしたユーザーID------" + user.uid);　//いいねした人のID
        });

        //クリックした時のサーバーに登録された　いいね　の数を取得
        firebase.database().ref('post/' + firebaseId).once("value").then(function(snapshot) {
        var likes = (snapshot.val() && snapshot.val().likesCount) ;
        var likePlus = 1; 
        var whiteHeartClick = parseInt(likes) - parseInt(likePlus)
        console.log(whiteHeartClick + "=【赤ハート】いいねの数(赤ハートクリックした時の処理)") //サーバーのいいね数に、１つマイナスした数

        //該当の　いいね数　を１減らす
        document.getElementById("likeCount").innerHTML = whiteHeartClick;
      });
    })
//赤ハートクリックで　いいね！　を１つマイナス　終わり



    </script>
    <!--ここはタイムラインを開いた時に最初に読み込まれる処理（一番目のイベントで一番目の#タグ） -->
    <!-- 投稿の読み込み -->
    <script>
      window.onload = readPost("whiteday2019");
    </script>

    <script src="js/likesCount.js"></script>

  </body>
</html>
